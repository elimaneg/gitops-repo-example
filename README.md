# Sample GitOps Repo

## Introduction

The given sample GitOps repo is an indication of the capability of the GitOps tool, the given repo structure constituting the entire GitOps configuration can be created by running a couple of day-1 and day-2 commands. A high level structure of the GitOps repo constitutes the config, environments folder and the pipelines.yaml file.  This git repo is generated by [kam](https://github.com/redhat-developer/kam) CLI tool.  It is for illustration purposes only.  To create your GitOps repository, use `kam` CLI instead.

#### Important Note:

This repository cannot be applied to the cluster since the sealed secrets are encrypted with the private key in the cluster at the time the repository was created.

### Pipelines.yaml

```yaml
config:
  argocd:
    namespace: argocd
  pipelines:
    name: cicd
environments:
- apps:
  - name: app-taxi
    services:
    - name: taxi
      pipelines:
        integration:
          bindings:
          - dev-app-taxi-taxi-binding
          - github-push-binding
      source_url: https://github.com/wtam2018/taxi.git
      webhook:
        secret:
          name: webhook-secret-dev-taxi
          namespace: cicd
  name: dev
  pipelines:
    integration:
      bindings:
      - github-push-binding
      template: app-ci-template
- apps:
  - name: app-bus
    services:
    - name: bus
      source_url: http://github.com/wtam2018/bus.git
      webhook:
        secret:
          name: webhook-secret-new-env-bus
          namespace: cicd
  name: new-env
  pipelines:
    integration:
      bindings:
      - github-push-binding
      template: app-ci-template
- name: stage
gitops_url: https://github.com/wtam2018/gitops.git
version: 1
```

The pipelines.yaml is a representation of the current directory structure, it throws light on the essential bits of the GitOps repo. The current GitOps repo structure can be broken down based on the pipelines.yaml file.

### High level directory structure

```
├── config
│   ├── argocd
│   │   ├── argo-app.yaml
│   │   ├── argocd.yaml
│   │   ├── cicd-app.yaml
│   │   ├── dev-app-taxi-app.yaml
│   │   ├── kustomization.yaml
│   │   └── new-env-app-bus-app.yaml
│   └── cicd
│       ├── base
│       │   ├── 01-namespaces
│       │   │   ├── cicd-environment.yaml
│       │   │   └── wtam.yaml
│       │   ├── 02-rolebindings
│       │   │   ├── commit-status-tracker-rolebinding.yaml
│       │   │   ├── commit-status-tracker-role.yaml
│       │   │   ├── commit-status-tracker-service-account.yaml
│       │   │   ├── internal-registry-wtam-binding.yaml
│       │   │   ├── pipeline-service-account.yaml
│       │   │   ├── pipeline-service-rolebinding.yaml
│       │   │   └── pipeline-service-role.yaml
│       │   ├── 03-secrets
│       │   │   ├── docker-config.yaml
│       │   │   ├── git-host-access-token.yaml
│       │   │   ├── git-host-basic-auth-token.yaml
│       │   │   ├── gitops-webhook-secret.yaml
│       │   │   ├── webhook-secret-dev-taxi.yaml
│       │   │   └── webhook-secret-new-env-bus.yaml
│       │   ├── 04-tasks
│       │   │   └── deploy-from-source-task.yaml
│       │   ├── 05-pipelines
│       │   │   ├── app-ci-pipeline.yaml
│       │   │   └── ci-dryrun-from-push-pipeline.yaml
│       │   ├── 06-bindings
│       │   │   ├── dev-app-taxi-taxi-binding.yaml
│       │   │   └── github-push-binding.yaml
│       │   ├── 07-templates
│       │   │   ├── app-ci-build-from-push-template.yaml
│       │   │   └── ci-dryrun-from-push-template.yaml
│       │   ├── 08-eventlisteners
│       │   │   └── cicd-event-listener.yaml
│       │   ├── 09-routes
│       │   │   └── gitops-webhook-event-listener.yaml
│       │   ├── 10-commit-status-tracker
│       │   │   └── operator.yaml
│       │   └── kustomization.yaml
│       └── overlays
│           └── kustomization.yaml
├── environments
│   ├── dev
│   │   ├── apps
│   │   │   └── app-taxi
│   │   │       ├── base
│   │   │       │   └── kustomization.yaml
│   │   │       ├── kustomization.yaml
│   │   │       ├── overlays
│   │   │       │   └── kustomization.yaml
│   │   │       └── services
│   │   │           └── taxi
│   │   │               ├── base
│   │   │               │   ├── config
│   │   │               │   │   ├── 100-deployment.yaml
│   │   │               │   │   ├── 200-service.yaml
│   │   │               │   │   └── kustomization.yaml
│   │   │               │   └── kustomization.yaml
│   │   │               ├── kustomization.yaml
│   │   │               └── overlays
│   │   │                   └── kustomization.yaml
│   │   └── env
│   │       ├── base
│   │       │   ├── dev-environment.yaml
│   │       │   ├── dev-rolebinding.yaml
│   │       │   └── kustomization.yaml
│   │       └── overlays
│   │           └── kustomization.yaml
│   ├── new-env
│   │   ├── apps
│   │   │   └── app-bus
│   │   │       ├── base
│   │   │       │   └── kustomization.yaml
│   │   │       ├── kustomization.yaml
│   │   │       ├── overlays
│   │   │       │   └── kustomization.yaml
│   │   │       └── services
│   │   │           └── bus
│   │   │               ├── base
│   │   │               │   ├── config
│   │   │               │   │   ├── 100-deployment.yaml
│   │   │               │   │   ├── 200-service.yaml
│   │   │               │   │   └── kustomization.yaml
│   │   │               │   └── kustomization.yaml
│   │   │               ├── kustomization.yaml
│   │   │               └── overlays
│   │   │                   └── kustomization.yaml
│   │   └── env
│   │       ├── base
│   │       │   ├── kustomization.yaml
│   │       │   ├── new-env-environment.yaml
│   │       │   └── new-env-rolebinding.yaml
│   │       └── overlays
│   │           └── kustomization.yaml
│   └── stage
│       └── env
│           ├── base
│           │   ├── kustomization.yaml
│           │   └── stage-environment.yaml
│           └── overlays
│               └── kustomization.yaml
├── pipelines.yaml
└── README.md
```

The entire structure can be explained by taking a look at the pipelines.yaml file since it contains a high level view of the contents in the GitOps repo. At the topmost level is divided into the config and environments directory.

### Config folder

The config directory refers to the special environments which contain the configuraion manifests for the ArgoCd and CI/CD environments.

```
├── config
    ├── argocd
    │   
    └── demo-cicd
```
* #### [ArgoCd sub-folder](https://github.com/rhd-gitops-example/docs/tree/master/model#argocd-environment)

* #### [CI/CD sub-folder](https://github.com/rhd-gitops-example/docs/tree/master/model#cicd-environment)

### Environments folder

Within a pipelines model, there are many environments which hold applications and services. Each environment has its own namespace/project as defined in openshift. The sample environments directory has the structure listed below.

```
├── environments
   └── prod
        ├── apps
        │   └── bus-app
        │       └── services
        │           ├── car
        │           ├── cycle
        │           └── rdisc-cli
        └── env

```

It comprises of :

* #### [Environment](https://github.com/rhd-gitops-example/docs/tree/master/model#plain-old-enviroment)

* #### [Application](https://github.com/rhd-gitops-example/docs/tree/master/model#application)

* #### [Service](https://github.com/rhd-gitops-example/docs/tree/master/model#service)

## Commands used to build sample repo
To create a GitOps repository that can be applied to the cluster, kindly run the commands showcased below. The following repo is build by running the following 3 commands:

### Day-1 operation
```shell
$ odo pipelines bootstrap --service-repo-url https://github.com/ishitasequeira/taxi.git \
  --dockercfgjson ~/Downloads/isequeir-robot-auth.json \
  --gitops-repo-url https://github.com/ishitasequeira/gitops166.git \
  --image-repo quay.io/isequeir/taxi --prefix demo --output ~/go/src/github.com/openshift/gitops \
  --sealed-secrets-svc sealed-secrets-controller --sealed-secrets-ns kube-system 
```
### Day-2 operation
```shell
$ odo pipelines environment add   --env-name prod \
  --pipelines-file  ~/go/src/github.com/openshift/gitops/pipelines.yaml
```

```shell
$ odo pipelines service add  --app-name bus-app --env-name prod \
  --pipelines-file ~/go/src/github.com/openshift/gitops \
  --service-name car --sealed-secrets-ns kube-system \
  --sealed-secrets-svc sealed-secrets-controller \
  --git-repo-url https://github.com/ishitasequeira/car.git 
```
